# 放置系陷阱地下城 Mod

## 简介
这是一个基于汉化版 [放置系陷阱地下城](https://sstm.moe/topic/303261-%E6%94%BE%E7%BD%AE%E7%B3%BB%E8%89%B2%E6%83%85%E9%99%B7%E9%98%B1%E5%9C%B0%E4%B8%8B%E5%9F%8E%E9%9B%B6%E9%A3%9F%E6%B1%89%E5%8C%96%E7%BB%84zh-games/) 的 Mod，提供了更高的加速倍率以及许多新的技能。

感谢原作者，以及汉化者为这个游戏付出的精力。

※本mod会影响游戏本体的设计和平衡，请自行考虑，酌情使用，be a smart person.

目前这个项目处于开发停止的状态，仅作为同作者的游戏的Mod开发参考。


### 通用变更

 - 增加了行为条件： 其他 -> 非战斗状态
 - 增加了若干Buff相关的行为条件
 - 游戏倍速统一提速 6 倍。

### 新增技能

```
多层护甲：
在开始探险的场合，获得"多层护甲+N"状态，N 为 [技能等级 * 物理抗性 / 40]。
当受到 束缚、道具付与 系 debuff 的场合发动：不再获得对应的 debuff；然后 多层护甲 状态 等级 - 1。当失去 多层护甲 状态 的场合，获得 “衣不遮体” 状态。
衣不遮体：
魔防 - 25%
防御 - 25%
敏捷 - 10%
抵抗 - 10%
敏感度（全部位） + 10%
全部位暴击概率 + 10%
缝补：在“衣不遮体”适用中的情景可以使用，5 回合内无法进行其他行动，然后重新获得对应层数的多层护甲。


灵击：在开始探险的场合，获得“灵击+N”状态，N 为 [技能等级 * 2]。当进行绝顶判定的场合发动：不绝顶，立刻消费 50% 当前魔法值，对所有敌人造成 [Buff层数 * 快感 / 200 / 5 * 消费魔法阵 ] 的伤害，然后将 快感 减半，灵击 状态 等级 - 1。当失去 灵击 状态 的场合，获得 “魔力耗尽”状态。
魔力耗尽：MP 上限降低 40%。魔法攻击 降低 20%

过肩摔：去除自己的所有束缚状态，对束缚自己的敌人造成伤害和眩晕（2回合），获得 “精疲力竭” 状态，持续 2 回合。
精疲力竭：闪避 额外进行一次判定，取更差的一次结果。

见切：获得“见切+N”状态， N 为 [技能等级*3]。
见切：在即将受到一次任何类型伤害时发动：对造成伤害的敌人造成 1 回合 眩晕，免除此次伤害，然后 无相转生 状态 等级 -1。当见切状态等级为 0 的场合，获得“精神涣散”状态，持续 1 回合。
精神涣散：敏捷降低 50%。
世界：获得 “世界”状态，持续 5 回合。
世界：自己无法进行行动，但可以闪避。当剩余回合数 为 0 的场合，获得“我的领域”，持续 9 回合。在时间暂停中依然会减少。如果在回合开始时，自己拥有“绝顶”状态，则失去本状态。
我的领域：敌人无法行动。
```

### 关于逆向方式的说明

其实可以直接看源代码。

主要是通过 Harmony 对相关的函数进行 Hook/重写。本来打算用 Bepinex 的，不过因为注入点不方便配置，所以直接使用了 Harmony。

一开始打算通过 winhttp.dll 这类 Bep 已有的 doorstop 来进行挂载，但是实际上修改 Import Table 后程序无法正常运行。最后采取了IL修改的方式：

```
namespace AutoEtd
{
// Token: 0x02000003 RID: 3
public class Program
{
// Token: 0x06000003 RID: 3 RVA: 0x000041EC File Offset: 0x000023EC
[STAThread]
public static void Main()
{
AppDomain.CurrentDomain.AssemblyResolve += Program.OnResolveAssembly;
Activator.CreateInstance(Assembly.LoadFile(Environment.CurrentDirectory + "\\Fzx_lib.dll").GetType("Fzx_lib.Program"));
App.Main();
}

//后略
```

在程序启动的部分加入了加载 dll 模块的代码。然后在对应的代码中调用 Harmony 进行 Hook 工作。因为Program基本没有其他的using，可以直接通过 dnSpy 进行编译，十分方便。



而具体的技能增加方面，排开使用日文/中文作为类名之外，整体的逻辑还是比较明确的。注意 SkillClasses -> BattleActions -> States（StateFactory） 的关联关系，就可以比较顺利地进行技能的开发。